name: Deploy to AWS Lightsail (Improved)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger

env:
  AWS_REGION: us-east-1
  LIGHTSAIL_SERVICE_NAME: arfid-app-production
  ENVIRONMENT: production
  POWER: micro
  STACK_NAME: arfid-production-infrastructure

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Run linting
        run: |
          flake8 app.py --max-line-length=120 --ignore=E501,W503 || true

      - name: Run tests
        run: |
          # pytest tests/ --cov=app
          echo "No tests configured yet"

  deploy-infrastructure:
    name: Deploy Infrastructure (CloudFormation)
    runs-on: ubuntu-latest
    needs: test
    permissions:
      id-token: write # Required for OIDC
      contents: read
    outputs:
      service_name: ${{ steps.cfn.outputs.service_name }}
      service_url: ${{ steps.cfn.outputs.service_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-${{ github.run_id }}

      - name: Validate CloudFormation template
        run: |
          echo "Validating CloudFormation template..."
          aws cloudformation validate-template \
            --template-body file://cloudformation/lightsail-service.yml \
            --region ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation stack
        id: cfn
        run: |
          echo "Deploying CloudFormation stack: ${{ env.STACK_NAME }}"

          # Check if stack exists for bootstrap parameter
          if aws cloudformation describe-stacks \
            --stack-name "${{ env.STACK_NAME }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Stacks[0].StackStatus' >/dev/null 2>&1; then
            echo "Stack exists. Updating..."
            STACK_EXISTS=true
          else
            echo "Stack does not exist. Creating..."
            STACK_EXISTS=false
          fi

          aws cloudformation deploy \
            --template-file cloudformation/lightsail-service.yml \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
                ServiceName=${{ env.LIGHTSAIL_SERVICE_NAME }} \
                Power=${{ env.POWER }} \
                Scale=1 \
                Environment=${{ env.ENVIRONMENT }} \
                HealthCheckPath=/api/start \
                ContainerPort=8000 \
            --tags \
                Environment=${{ env.ENVIRONMENT }} \
                Application=ARFID \
                ManagedBy=GitHubActions \
                Repository=${{ github.repository }} \
                CommitSHA=${{ github.sha }} \
            --no-fail-on-empty-changeset

          # Get outputs
          SERVICE_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ServiceName`].OutputValue' \
            --output text)

          SERVICE_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ServiceUrl`].OutputValue' \
            --output text)

          echo "service_name=$SERVICE_NAME" >> "$GITHUB_OUTPUT"
          echo "service_url=$SERVICE_URL" >> "$GITHUB_OUTPUT"

          echo "‚úÖ Lightsail service: $SERVICE_NAME"
          echo "‚úÖ Service URL: $SERVICE_URL"

      - name: Wait for Lightsail service to be ready
        env:
          SERVICE_NAME: ${{ steps.cfn.outputs.service_name }}
        run: |
          echo "Waiting for Lightsail service to be ready..."
          for i in {1..30}; do
            STATE=$(aws lightsail get-container-services \
              --service-name "$SERVICE_NAME" \
              --query 'containerServices[0].state' \
              --output text)

            echo "Current state: $STATE (attempt $i/30)"

            case "$STATE" in
              RUNNING|READY|ACTIVE)
                echo "‚úÖ Service is ready!"
                exit 0
                ;;
              CREATING|PREPARING|PENDING|UPDATING|DEPLOYING)
                echo "Deployment in progress. Waiting..."
                sleep 10
                ;;
              DISABLED|PAUSED)
                echo "‚ö†Ô∏è Service is $STATE. Please enable or resume it."
                exit 1
                ;;
              DELETING)
                echo "‚ùå Service is being deleted."
                exit 1
                ;;
              *)
                echo "‚ÑπÔ∏è Unexpected state '$STATE'. Waiting..."
                sleep 10
                ;;
            esac
          done

          echo "‚ö†Ô∏è Timeout waiting for service to be ready"
          exit 1

  build-and-deploy-containers:
    name: Build and Deploy Containers
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-${{ github.run_id }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -sSL "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"
          chmod +x /usr/local/bin/lightsailctl

      - name: Build Docker images
        run: |
          echo "Building web image..."
          docker build -t arfid-web:${{ github.sha }} -f Dockerfile .

          echo "Building worker image..."
          docker build -t arfid-worker:${{ github.sha }} -f Dockerfile.worker .

      - name: Push web image to Lightsail
        id: push-web
        env:
          SERVICE_NAME: ${{ needs.deploy-infrastructure.outputs.service_name }}
        run: |
          echo "Pushing web container image..."
          aws lightsail push-container-image \
            --service-name "$SERVICE_NAME" \
            --label arfid-web \
            --image arfid-web:${{ github.sha }} \
            --output json 2>&1 | tee push-web-output.log

          # Parse output to get image name
          JSON_OUTPUT=$(sed -n '/^{/,$p' push-web-output.log | tr -d '\r')
          REFER_LINE=$(grep -E 'Refer to this image as' push-web-output.log | tail -n1)

          if [ -n "$JSON_OUTPUT" ]; then
            IMAGE_NAME=$(echo "$JSON_OUTPUT" | jq -r '.image')
          elif [ -n "$REFER_LINE" ]; then
            IMAGE_NAME=$(echo "$REFER_LINE" | sed -E 's/.*"([^"]+)".*/\1/')
          else
            echo "::error::Failed to parse web image name"
            exit 1
          fi

          echo "web_image=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Web image: $IMAGE_NAME"

      - name: Push worker image to Lightsail
        id: push-worker
        env:
          SERVICE_NAME: ${{ needs.deploy-infrastructure.outputs.service_name }}
        run: |
          echo "Pushing worker container image..."
          aws lightsail push-container-image \
            --service-name "$SERVICE_NAME" \
            --label arfid-worker \
            --image arfid-worker:${{ github.sha }} \
            --output json 2>&1 | tee push-worker-output.log

          # Parse output to get image name
          JSON_OUTPUT=$(sed -n '/^{/,$p' push-worker-output.log | tr -d '\r')
          REFER_LINE=$(grep -E 'Refer to this image as' push-worker-output.log | tail -n1)

          if [ -n "$JSON_OUTPUT" ]; then
            IMAGE_NAME=$(echo "$JSON_OUTPUT" | jq -r '.image')
          elif [ -n "$REFER_LINE" ]; then
            IMAGE_NAME=$(echo "$REFER_LINE" | sed -E 's/.*"([^"]+)".*/\1/')
          else
            echo "::error::Failed to parse worker image name"
            exit 1
          fi

          echo "worker_image=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Worker image: $IMAGE_NAME"

      - name: Deploy containers to Lightsail
        env:
          SERVICE_NAME: ${{ needs.deploy-infrastructure.outputs.service_name }}
          WEB_IMAGE: ${{ steps.push-web.outputs.web_image }}
          WORKER_IMAGE: ${{ steps.push-worker.outputs.worker_image }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_VECTOR_STORE_ID: ${{ secrets.OPENAI_VECTOR_STORE_ID }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          echo "Creating deployment for $SERVICE_NAME..."

          # Create containers configuration
          cat > containers.json <<'CONTAINERS_EOF'
          {
            "web": {
              "image": "$WEB_IMAGE",
              "ports": {
                "8000": "HTTP"
              },
              "environment": {
                "OPENAI_API_KEY": "$OPENAI_API_KEY",
                "OPENAI_VECTOR_STORE_ID": "$OPENAI_VECTOR_STORE_ID",
                "FLASK_SECRET_KEY": "$FLASK_SECRET_KEY",
                "REDIS_URL": "$REDIS_URL"
              }
            },
            "worker": {
              "image": "$WORKER_IMAGE",
              "environment": {
                "OPENAI_API_KEY": "$OPENAI_API_KEY",
                "OPENAI_VECTOR_STORE_ID": "$OPENAI_VECTOR_STORE_ID",
                "FLASK_SECRET_KEY": "$FLASK_SECRET_KEY",
                "REDIS_URL": "$REDIS_URL"
              }
            }
          }
          CONTAINERS_EOF

          # Substitute environment variables
          sed -i "s|\$WEB_IMAGE|$WEB_IMAGE|g" containers.json
          sed -i "s|\$WORKER_IMAGE|$WORKER_IMAGE|g" containers.json
          sed -i "s|\$OPENAI_API_KEY|$OPENAI_API_KEY|g" containers.json
          sed -i "s|\$OPENAI_VECTOR_STORE_ID|$OPENAI_VECTOR_STORE_ID|g" containers.json
          sed -i "s|\$FLASK_SECRET_KEY|$FLASK_SECRET_KEY|g" containers.json
          sed -i "s|\$REDIS_URL|$REDIS_URL|g" containers.json

          # Create public endpoint configuration
          cat > endpoint.json <<'ENDPOINT_EOF'
          {
            "containerName": "web",
            "containerPort": 8000,
            "healthCheck": {
              "healthyThreshold": 2,
              "unhealthyThreshold": 2,
              "timeoutSeconds": 5,
              "intervalSeconds": 30,
              "path": "/api/start",
              "successCodes": "200-299,202"
            }
          }
          ENDPOINT_EOF

          # Deploy
          aws lightsail create-container-service-deployment \
            --service-name "$SERVICE_NAME" \
            --containers file://containers.json \
            --public-endpoint file://endpoint.json

          echo "‚úÖ Deployment initiated"

      - name: Wait for deployment
        env:
          SERVICE_NAME: ${{ needs.deploy-infrastructure.outputs.service_name }}
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30

          for i in {1..20}; do
            STATE=$(aws lightsail get-container-services \
              --service-name "$SERVICE_NAME" \
              --query 'containerServices[0].state' \
              --output text)

            echo "Deployment state: $STATE (attempt $i/20)"

            if [ "$STATE" = "RUNNING" ]; then
              echo "‚úÖ Deployment successful!"
              break
            elif [ "$STATE" = "FAILED" ]; then
              echo "‚ùå Deployment failed!"
              exit 1
            fi

            sleep 15
          done

      - name: Test deployment
        env:
          SERVICE_URL: ${{ needs.deploy-infrastructure.outputs.service_url }}
        run: |
          echo "Testing deployment at https://$SERVICE_URL..."
          curl -f "https://$SERVICE_URL/api/start" || echo "‚ö†Ô∏è Health check warning (may be normal for async endpoints)"

      - name: Create deployment summary
        run: |
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service Name:** \`${{ needs.deploy-infrastructure.outputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** https://${{ needs.deploy-infrastructure.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web Image:** \`${{ steps.push-web.outputs.web_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Image:** \`${{ steps.push-worker.outputs.worker_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment is now live and processing requests!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: build-and-deploy-containers
    if: always()

    steps:
      - name: Deployment Success
        if: needs.build-and-deploy-containers.result == 'success'
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Your app is now live on AWS Lightsail"

      - name: Deployment Failed
        if: needs.build-and-deploy-containers.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details"
          exit 1
